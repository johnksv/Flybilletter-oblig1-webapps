@model Flybilletter.Models.BestillingViewModel

@{
    ViewBag.Title = "Bestille";
}

<h2>Informasjon om bestilling</h2>

<h3>@Model.Fra - @Model.Til</h3>



@foreach (var item in Model.Flygninger)
{
    @Html.DisplayFor(model => item);
}

<hr />
<h3>Reisende</h3>



@for (int i = 0, antall = 1; i < Model.Kunder.Count; i++, antall++)
{
    using (Html.BeginForm(null, null, FormMethod.Post, new { id = "confirmForm-" + i, @class = "passasjerBekreftelse", @autocomplete = "false" })) ///Home/BestillingDetaljer
    {
        @Html.AntiForgeryToken()
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Passasjer @antall</h3>
            </div>

            <div class="panel-body">
                <fieldset id="kundeInformasjon-@i">
                    @Html.EditorFor(model => model.Kunder[i], new { htmlAttributes = new { @class = "form-control" } })
                    @Html.ValidationMessageFor(model => model.Kunder, "", new { @class = "text-danger" })
                </fieldset>
            </div>

            <div class="panel-footer">
                <button id="kundeInformasjonBtn-@i" class="btn btn-success">Bekreft informasjon</button>
            </div>
        </div>
    }
}

<div class="modal" id="betalingsinformasjon" role="dialog">

    <div class="modal-dialog" role="document">
        <div class="modal-content">
            @Html.Partial("_Betaling")
        </div>
    </div>
</div>

<div id="valideringFeilmelding" class="alert alert-warning hidden" role="alert">
    <strong>Feil!</strong> Alle felter må bekreftes før man kan gå til betaling.
</div>

<div class="col-md-12">
    <button id="gaaTilBetaling" class="btn btn-success">Gå til betaling</button>
    <button class="btn btn-primary">Tilbake til søk</button>
</div>



<script>
    $(function () {
        var antallKunder = @Model.Kunder.Count;
        for (var i = 0; i < antallKunder; i++) {
            $("#kundeInformasjonBtn-" + i).click(function (event) {
                handleKundeInfoBtnClick(event, $(this).index() );
            });
        }

        $("#gaaTilBetaling").click(function (event) {
            var isValid = true;
            var isBekreftet = true;

            //Sjekk at alle forms er validert, samt bekreftet av bruker
            $(".passasjerBekreftelse").each(function () {
                var valid = $(this).valid();
                if (!valid) isValid = false;

                var bekreftet = $(this).find("fieldset").prop("disabled");
                if (!bekreftet) isBekreftet = false;
            });

            if (isValid && isBekreftet) {
                $("#betalingsinformasjon").modal();
                $("#valideringFeilmelding").addClass("hidden");
            } else {
                $("#valideringFeilmelding").removeClass("hidden");
            }

        });

    });

    function handleKundeInfoBtnClick(event, idNr) {
        event.preventDefault();
        var btnId = "#kundeInformasjonBtn-" + idNr;
        var fieldSetId = "#kundeInformasjon-" + idNr;

        var isDisabled = $(fieldSetId).prop('disabled');
        var isValid = $("#confirmForm-" + idNr).valid();

        if (isDisabled) {
            $(btnId).text("Bekreft informasjon");
        } else if (isValid) {
            $(btnId).text("Endre informasjon");
        } else {
            return; //Hvis formen ikke er valid
        }

        $(fieldSetId).prop('disabled', !isDisabled);
        $(btnId).toggleClass("btn-success");
        $(btnId).toggleClass("btn-warning");
    }

</script>